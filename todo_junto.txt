--- rental-mvp/estructura_directorios.json ---
[
    {
        "name": "rental-mvp",
        "dirs": [
            {
                "name": "uploads",
                "dirs": [],
                "files": [
                    "813d5d79-c6ed-4454-bcf8-cea86969abef.png",
                    "3d304b92-4fce-4616-a08f-b74313d0008c.png",
                    "2a373a03-bd9c-4d50-93bc-e546e44bd6f1.png",
                    "41671a81-0d71-4490-9dd9-1629cd2811ee.png",
                    "282022c2-0d6d-4f87-bcc9-ecd08d43a362.png",
                    "249e28c1-feb7-4a38-a488-3bea7af0c2fd.png",
                    "570df2ae-13d6-4156-968d-6cde19da881d.png",
                    "a08a849a-2bcf-4c62-8f50-320a0d3b843f.jpg",
                    "ebefe732-4f9a-46dd-a033-8072611d8ad9.png",
                    "f528fc74-9c61-432c-a79a-0eb5da4f6b76.png",
                    "aa787f08-437e-4068-80bf-71d891088c56.png",
                    "5ce5fe11-0cef-4e78-a78b-aa643b94a56d.png"
                ]
            },
            {
                "name": "frontend",
                "dirs": [
                    {
                        "name": "src",
                        "dirs": [
                            {
                                "name": "hooks",
                                "dirs": [],
                                "files": [
                                    "useAuth.tsx"
                                ]
                            },
                            {
                                "name": "styles",
                                "dirs": [],
                                "files": [
                                    "global.css"
                                ]
                            },
                            {
                                "name": "features",
                                "dirs": [
                                    {
                                        "name": "auth",
                                        "dirs": [],
                                        "files": [
                                            "register.ts",
                                            "login.ts"
                                        ]
                                    },
                                    {
                                        "name": "categories",
                                        "dirs": [],
                                        "files": [
                                            "useCategories.ts"
                                        ]
                                    },
                                    {
                                        "name": "items",
                                        "dirs": [],
                                        "files": [
                                            "useItems.ts",
                                            "AddItemModal.tsx",
                                            "ItemList.tsx"
                                        ]
                                    },
                                    {
                                        "name": "rentals",
                                        "dirs": [],
                                        "files": [
                                            "RentalList.tsx",
                                            "useRentals.ts"
                                        ]
                                    }
                                ],
                                "files": []
                            },
                            {
                                "name": "pages",
                                "dirs": [],
                                "files": [
                                    "Register.tsx",
                                    "Login.tsx",
                                    "Dashboard.tsx",
                                    "Home.tsx"
                                ]
                            },
                            {
                                "name": "components",
                                "dirs": [
                                    {
                                        "name": "ui",
                                        "dirs": [],
                                        "files": [
                                            "SkeletonCard.tsx",
                                            "LazyImage.tsx",
                                            "ItemCard.tsx",
                                            "SearchBar.tsx",
                                            "SocialButton.tsx",
                                            "QuickViewModal.tsx"
                                        ]
                                    },
                                    {
                                        "name": "shared",
                                        "dirs": [],
                                        "files": [
                                            "Section.tsx",
                                            "Container.tsx"
                                        ]
                                    },
                                    {
                                        "name": "layout",
                                        "dirs": [],
                                        "files": [
                                            "Footer.tsx",
                                            "Header.tsx"
                                        ]
                                    },
                                    {
                                        "name": "filters",
                                        "dirs": [],
                                        "files": [
                                            "FiltersSidebar.tsx"
                                        ]
                                    }
                                ],
                                "files": []
                            }
                        ],
                        "files": [
                            "App.tsx",
                            "main.tsx",
                            "utils.ts"
                        ]
                    }
                ],
                "files": [
                    "index.html",
                    "package.json",
                    "vite.config.ts",
                    "tsconfig.json",
                    "postcss.config.js",
                    "tailwind.config.js"
                ]
            },
            {
                "name": "app",
                "dirs": [
                    {
                        "name": "models",
                        "dirs": [],
                        "files": [
                            "models.py",
                            "__init__.py",
                            "database.py"
                        ]
                    },
                    {
                        "name": "schemas",
                        "dirs": [],
                        "files": [
                            "category.py",
                            "rental.py",
                            "token.py",
                            "__init__.py",
                            "item.py",
                            "user.py"
                        ]
                    },
                    {
                        "name": "crud",
                        "dirs": [],
                        "files": [
                            "category.py",
                            "rental.py",
                            "__init__.py",
                            "item.py",
                            "user.py"
                        ]
                    },
                    {
                        "name": "core",
                        "dirs": [],
                        "files": [
                            "config.py",
                            "security.py"
                        ]
                    },
                    {
                        "name": "api",
                        "dirs": [],
                        "files": [
                            "rentals.py",
                            "items.py",
                            "categories.py",
                            "auth.py",
                            "__init__.py",
                            "upload.py"
                        ]
                    }
                ],
                "files": [
                    "main.py",
                    "deps.py"
                ]
            },
            {
                "name": "tests",
                "dirs": [],
                "files": [
                    "test_api.py",
                    "conftest.py"
                ]
            },
            {
                "name": ".pytest_cache",
                "dirs": [
                    {
                        "name": "v",
                        "dirs": [
                            {
                                "name": "cache",
                                "dirs": [],
                                "files": [
                                    "nodeids",
                                    "lastfailed"
                                ]
                            }
                        ],
                        "files": []
                    }
                ],
                "files": [
                    ".gitignore",
                    "README.md",
                    "CACHEDIR.TAG"
                ]
            }
        ],
        "files": [
            "estructura_directorios.json",
            "requirements.txt",
            "pytest.ini",
            ".env",
            "rental.db",
            "alembic.ini"
        ]
    }
]

--- rental-mvp/requirements.txt ---
# rental-mvp/requirements.txt
alembic==1.16.3
annotated-types==0.7.0
anyio==4.9.0
bcrypt==3.2.2  
cffi==1.17.1
click==8.2.1
cryptography==45.0.5
ecdsa==0.19.1
exceptiongroup==1.3.0
fastapi==0.116.0
greenlet==3.2.3
h11==0.16.0
httptools==0.6.4
idna==3.10
Mako==1.3.10
MarkupSafe==3.0.2
passlib==1.7.4
pyasn1==0.6.1
pycparser==2.22
pydantic==2.11.7
pydantic-core==2.33.2
pydantic-settings==2.10.1
python-dotenv==1.1.1
python-jose[cryptography]==3.5.0
python-multipart==0.0.6
PyYAML==6.0.2
rsa==4.9.1
six==1.17.0
sniffio==1.3.1
SQLAlchemy==2.0.41
starlette==0.46.2
tomli==2.2.1
typing-inspection==0.4.1
typing-extensions==4.14.1
uvicorn==0.35.0
uvloop==0.21.0
watchfiles==1.1.0
websockets==15.0.1
email-validator
pytest>=7.4
httpx>=0.27

--- rental-mvp/docker-compose.prod.yml ---
version: "3.9"

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    env_file: .env
    volumes:
      - uploads:/app/uploads          # im√°genes persisten
      - ./rental.db:/app/rental.db    # sqlite fuera de imagen
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    depends_on:
      - backend
    ports:
      - "80:80"                       # expone HTTP
    restart: unless-stopped

volumes:
  uploads:


--- rental-mvp/pytest.ini ---
# pytest.ini
[pytest]
pythonpath = .
addopts = -q


--- rental-mvp/.env ---
# .env (en la ra√≠z)
DATABASE_URL=sqlite:///./rental.db
SECRET_KEY=tu_clave_super_secreta_aleatoria


--- rental-mvp/Dockerfile ---
# backend/Dockerfile
FROM python:3.12-slim

# Instala dependencias del SO necesarias para wheel, bcrypt, etc.
RUN apt-get update && apt-get install -y build-essential libffi-dev git && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copiamos solo el backend y la config; el front se servir√° por Nginx
COPY app ./app
COPY .env .
COPY uploads ./uploads          

EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]


--- rental-mvp/alembic.ini ---
# A generic, single database configuration.

[alembic]
# path to migration scripts.
# this is typically a path given in POSIX (e.g. forward slashes)
# format, relative to the token %(here)s which refers to the location of this
# ini file
script_location = %(here)s/alembic

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# see https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file
# for all available tokens
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.  for multiple paths, the path separator
# is defined by "path_separator" below.
prepend_sys_path = .


# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the python>=3.9 or backports.zoneinfo library and tzdata library.
# Any required deps can installed by adding `alembic[tz]` to the pip requirements
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the "slug" field
# truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to <script_location>/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# The path separator used here should be the separator specified by "path_separator"
# below.
# version_locations = %(here)s/bar:%(here)s/bat:%(here)s/alembic/versions

# path_separator; This indicates what character is used to split lists of file
# paths, including version_locations and prepend_sys_path within configparser
# files such as alembic.ini.
# The default rendered in new alembic.ini files is "os", which uses os.pathsep
# to provide os-dependent path splitting.
#
# Note that in order to support legacy alembic.ini files, this default does NOT
# take place if path_separator is not present in alembic.ini.  If this
# option is omitted entirely, fallback logic is as follows:
#
# 1. Parsing of the version_locations option falls back to using the legacy
#    "version_path_separator" key, which if absent then falls back to the legacy
#    behavior of splitting on spaces and/or commas.
# 2. Parsing of the prepend_sys_path option falls back to the legacy
#    behavior of splitting on spaces, commas, or colons.
#
# Valid values for path_separator are:
#
# path_separator = :
# path_separator = ;
# path_separator = space
# path_separator = newline
#
# Use os.pathsep. Default configuration used for new projects.
path_separator = os

# set to 'true' to search source files recursively
# in each "version_locations" directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

# database URL.  This is consumed by the user-maintained env.py script only.
# other means of configuring database URLs may be customized within the env.py
# file.
sqlalchemy.url = sqlite:///./rental.db


[post_write_hooks]
# post_write_hooks defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using "black" - use the console_scripts runner, against the "black" entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using "ruff" - use the module runner, against the "ruff" module
# hooks = ruff
# ruff.type = module
# ruff.module = ruff
# ruff.options = check --fix REVISION_SCRIPT_FILENAME

# Alternatively, use the exec runner to execute a binary found on your PATH
# hooks = ruff
# ruff.type = exec
# ruff.executable = ruff
# ruff.options = check --fix REVISION_SCRIPT_FILENAME

# Logging configuration.  This is also consumed by the user-maintained
# env.py script only.
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARNING
handlers = console
qualname =

[logger_sqlalchemy]
level = WARNING
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S


--- rental-mvp/frontend/index.html ---
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rental-MVP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>


--- rental-mvp/frontend/package.json ---
{
  "name": "rental-mvp-frontend",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "lint": "eslint \"src/**/*.{ts,tsx}\" --max-warnings=0 --fix"
  },
  "dependencies": {
    "@headlessui/react": "^2.2.4",
    "@heroicons/react": "^2.2.0",
    "axios": "^1.6.8",
    "clsx": "^2.1.1",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-hook-form": "^7.60.0",
    "react-hot-toast": "^2.5.2",
    "react-icons": "^5.5.0",
    "react-router-dom": "^6.23.1",
    "zxcvbn": "^4.4.2"
  },
  "devDependencies": {
    "@tailwindcss/forms": "^0.5.10",
    "@tailwindcss/line-clamp": "^0.4.4",
    "@tailwindcss/typography": "^0.5.16",
    "@types/react": "^18.3.5",
    "@types/react-dom": "^18.3.2",
    "@typescript-eslint/eslint-plugin": "^7.18.0",
    "@typescript-eslint/parser": "^7.18.0",
    "@vitejs/plugin-react": "^4.2.0",
    "autoprefixer": "^10.4.20",
    "eslint": "^8.57.0",
    "eslint-plugin-react": "^7.34.1",
    "eslint-plugin-react-hooks": "^4.6.0",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.4",
    "typescript": "^5.5.0",
    "vite": "^5.3.1"
  }
}


--- rental-mvp/frontend/vite.config.ts ---
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    proxy: {
      // ‚ñ∫ redirige API a tu back (FastAPI en :8000)
      "/api": "http://localhost:8000"
    }
  }
});


--- rental-mvp/frontend/Dockerfile ---
# frontend/Dockerfile
# Etapa 1 ‚Äì compilaci√≥n
FROM node:20 AS builder
WORKDIR /frontend
COPY frontend/package.json frontend/package-lock.json* ./
RUN npm ci
COPY frontend .
RUN npm run build           # salida en /frontend/dist

# Etapa 2 ‚Äì Nginx est√°tico
FROM nginx:1.27-alpine
COPY --from=builder /frontend/dist /usr/share/nginx/html
# Proxy /api ‚Üí backend
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]


--- rental-mvp/frontend/nginx.conf ---
server {
    listen 80;
    server_name _;

    # est√°ticos de Vite
    root /usr/share/nginx/html;
    index index.html;

    # single-page
    location / {
        try_files $uri $uri/ /index.html;
    }

    # proxy API
    location /api/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # subidas
    location /uploads/ {
        proxy_pass http://backend:8000;
    }
}


--- rental-mvp/frontend/tsconfig.json ---
{
    "compilerOptions": {
        "target": "ES2022",
        "lib": [
            "DOM",
            "DOM.Iterable",
            "ES2022"
        ],
        "module": "ESNext",
        "moduleResolution": "Node",
        "types": [
            "vite/client"
        ],
        "strict": true,
        "jsx": "react-jsx",
        "resolveJsonModule": true,
        "esModuleInterop": true,
        "skipLibCheck": true,
        "forceConsistentCasingInFileNames": true
    },
    "include": [
        "src"
    ]
}

--- rental-mvp/frontend/postcss.config.js ---
// rental-mvp/frontend/postcss.config.js
export default {
    plugins: {
        tailwindcss: {},
        autoprefixer: {}
    }
};


--- rental-mvp/frontend/tailwind.config.js ---
/** @type {import('tailwindcss').Config} */
module.exports = {
    content: ['./index.html', './src/**/*.{ts,tsx}'],
    theme: {
        container: { center: true, padding: '1rem' },
        extend: {
            fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
            colors: {
                brand: { DEFAULT: '#0d6efd', hover: '#0b5ed7' },
                surface: '#ffffff'
            },
            boxShadow: {
                card: '0 1px 3px rgba(0,0,0,.08)',
                cardHover: '0 4px 12px rgba(0,0,0,.12)'
            }
        }
    },
    plugins: [
        require('@tailwindcss/forms'),
        require('@tailwindcss/typography'),
        require('@tailwindcss/line-clamp')       //  ‚Üê NEW
    ]
};


--- rental-mvp/frontend/src/App.tsx ---
import { BrowserRouter, Routes, Route } from "react-router-dom";
import { AuthProvider } from "./hooks/useAuth";
import Header from "./components/layout/Header";
import Home from "./pages/Home";
import Login from "./pages/Login";
import Dashboard from "./pages/Dashboard";
import Footer from './components/layout/Footer';
import Register from "./pages/Register";
import "./styles/global.css";

export default function App() {
  return (
    <AuthProvider>
      <BrowserRouter>
        <Header />
        <Routes>
          <Route path="/" element={<Home />} />
          <Route path="/login" element={<Login />} />
          <Route path="/dashboard" element={<Dashboard />} />
          <Route path="/register" element={<Register />} />
        </Routes>
        <Footer />
      </BrowserRouter>
    </AuthProvider>
  );
}


--- rental-mvp/frontend/src/main.tsx ---
// src/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import { Toaster } from 'react-hot-toast';          // üÜï
import './styles/global.css';

ReactDOM.createRoot(document.getElementById('root') as HTMLElement).render(
  <React.StrictMode>
    <App />
    <Toaster                                         // üÜï
      position="top-right"
      toastOptions={{
        style: { fontSize: '0.875rem' },            // 14 px
        duration: 3000
      }}
    />
  </React.StrictMode>
);


--- rental-mvp/frontend/src/utils.ts ---
// utils.ts
/**
 * URL base de la API.  Ajusta en .env.local si no usas localhost:8000
 *   VITE_API_BASE_URL=https://tu-dominio.com
 */
export const API_BASE =
  import.meta.env.VITE_API_BASE_URL ?? "http://localhost:8000";

/**  
 * Devuelve una URL de imagen v√°lida.
 * - Si ya es absoluta ‚Üí la deja tal cual.
 * - Si empieza por ‚Äú/‚Äù ‚Üí la concatena con API_BASE.
 * - Si viene `undefined` ‚Üí usa el *fallback*.
 */
export function resolveImage(url: string | undefined, fallback: string) {
  if (!url) return fallback;
  if (/^https?:\/\//i.test(url)) return url; // absoluta
  return `${API_BASE}${url.startsWith("/") ? "" : "/"}${url}`;
}


--- rental-mvp/frontend/src/hooks/useAuth.tsx ---
import React, { createContext, useContext, useState } from "react";

type AuthContextT = {
  token: string | null;
  login: (t: string) => void;
  logout: () => void;
};

const AuthContext = createContext<AuthContextT | undefined>(undefined);

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({
  children
}) => {
  const [token, setToken] = useState<string | null>(
    () => localStorage.getItem("token")
  );

  const login = (t: string) => {
    localStorage.setItem("token", t);
    setToken(t);
  };

  const logout = () => {
    localStorage.removeItem("token");
    setToken(null);
  };

  return (
    <AuthContext.Provider value={{ token, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error("useAuth debe usarse dentro de <AuthProvider>");
  return ctx;
};


--- rental-mvp/frontend/src/styles/global.css ---
/* frontend/src/styles/global.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* ----- BASE ----- */
@layer base {
  html { @apply scroll-smooth; }
  body { @apply bg-gray-50 text-gray-800 antialiased font-sans; }
}

/* ----- COMPONENTS ----- */
@layer components {
  /* Botones */
  .btn        { @apply inline-flex items-center justify-center rounded-md bg-brand px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-brand-hover disabled:opacity-60; }
  .btn--ghost { @apply inline-flex items-center justify-center rounded-md border border-brand px-4 py-2 text-sm font-medium text-brand transition-colors hover:bg-brand/5; }

  /* Badges */
  .badge          { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium; }
  .badge--ok      { @apply badge bg-green-100 text-green-800; }
  .badge--danger  { @apply badge bg-red-100 text-red-800; }
}

/* ----- UTILITIES PERSONALIZADAS ----- */
@layer utilities {
  .text-balance { text-wrap: balance; }
}

@layer components {
  .form-select { @apply block w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-brand focus:ring-brand; }
}

@layer components {
  .toast-success { @apply bg-green-600 text-white; }
  .toast-error   { @apply bg-red-600 text-white; }
}

--- rental-mvp/frontend/src/features/auth/register.ts ---
// src/features/auth/register.ts
import axios from "axios";

/** Lanza 400 si el username o el email ya est√°n en uso. */
export async function register(
  username: string,
  email: string,
  password: string
): Promise<void> {
  await axios.post("/api/auth/signup", { username, email, password });
}


--- rental-mvp/frontend/src/features/auth/login.ts ---
import axios from "axios";

export async function login(username: string, password: string): Promise<string> {
  const { data } = await axios.post(
    "/api/auth/token",
    new URLSearchParams({ username, password }),
    {
      headers: { "Content-Type": "application/x-www-form-urlencoded" }
    }
  );
  return data.access_token as string;
}


--- rental-mvp/frontend/src/features/categories/useCategories.ts ---
import { useEffect, useState } from 'react';
import axios from 'axios';

export type Category = { id: number; name: string };

export default function useCategories() {
  const [data, setData] = useState<Category[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    axios
      .get<Category[]>('/api/categories/')
      .then(r => setData(r.data))
      .finally(() => setLoading(false));
  }, []);

  return { data, loading };
}


--- rental-mvp/frontend/src/features/items/useItems.ts ---
import { useEffect, useState } from "react";
import axios from "axios";

export type Item = {
  id: number;
  name: string;
  description?: string;
  price_per_h: number;
  available: boolean;
  image_url?: string;          // üÜï  ‚Üê a√±ade la propiedad
  categories?: { id: number; name: string }[];
};


export function useItems(params?: URLSearchParams) {
  const [data, setData] = useState<Item[]>([]);
  const [loading, setLoading] = useState(true);
  const [reload, setReload] = useState(0);

  useEffect(() => {
    setLoading(true);
    axios
      .get<Item[]>("/api/items/", { params })
      .then(res => setData(res.data))
      .catch(console.error)
      .finally(() => setLoading(false));
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [params?.toString(), reload]);

  return { data, loading, refetch: () => setReload(r => r + 1) };
}


--- rental-mvp/frontend/src/features/items/AddItemModal.tsx ---
import { Fragment, useEffect, useState } from "react";
import { Dialog, Transition } from "@headlessui/react";
import { XMarkIcon, PhotoIcon } from "@heroicons/react/24/outline";
import { useForm } from "react-hook-form";
import { z } from "zod";
import { zodResolver } from "@hookform/resolvers/zod";
import axios from "axios";
import toast from "react-hot-toast";
import useCategories, { Category } from "../categories/useCategories";
import { useAuth } from "../../hooks/useAuth";

/* -------------------------------------------------------------------------- */
/*                               schema + types                               */
/* -------------------------------------------------------------------------- */

const priceRegex = /^\d+([.,]\d{1,2})?$/; // hasta 2 decimales

const schema = z.object({
  name: z.string().min(3, "M√≠nimo 3 caracteres"),
  description: z.string().max(500).optional(),
  price_per_h: z
    .string()
    .regex(priceRegex, "Precio inv√°lido")
    .transform(v => Number(v.replace(",", "."))),
  categories: z.array(z.number()).min(1, "Selecciona al menos una categor√≠a"),
  image: z
    .instanceof(File)
    .refine(f => f.size < 5 * 1024 * 1024, "M√°x. 5 MB")
    .optional()
});

type FormData = z.infer<typeof schema>;

type Props = {
  open: boolean;
  onClose: () => void;
  onCreated: () => void; // callback para refrescar listado
};

/* -------------------------------------------------------------------------- */

export default function AddItemModal({ open, onClose, onCreated }: Props) {
  const { data: cats } = useCategories();
  const { token } = useAuth();

  const {
    register,
    handleSubmit,
    watch,
    reset,
    setValue,
    formState: { errors, isSubmitting }
  } = useForm<FormData>({
    resolver: zodResolver(schema),
    defaultValues: { categories: [] }
  });

  /* preview de imagen ------------------------------------------------------ */
  const file = watch("image");
  const [preview, setPreview] = useState<string | null>(null);

  useEffect(() => {
    if (file && file instanceof File) {
      const url = URL.createObjectURL(file);
      setPreview(url);
      return () => URL.revokeObjectURL(url);
    }
    setPreview(null);
  }, [file]);

  /* submit ----------------------------------------------------------------- */
  async function onSubmit(data: FormData) {
    if (!token) {
      toast.error("Debes haber iniciado sesi√≥n");
      return;
    }
    try {
      /* 1.- subimos imagen (opcional) */
      let image_url: string | undefined;
      if (data.image) {
        const fd = new FormData();
        fd.append("file", data.image);
        const up = await axios.post<{ url: string }>("/api/upload/", fd, {
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "multipart/form-data"
          }
        });
        image_url = up.data.url;
      }

      /* 2.- creamos √≠tem */
      await axios.post(
        "/api/items/",
        {
          name: data.name,
          description: data.description,
          price_per_h: data.price_per_h,
          categories: data.categories,
          image_url
        },
        { headers: { Authorization: `Bearer ${token}` } }
      );

      toast.success("¬°Producto publicado!");
      reset();          // limpia formulario
      onCreated();      // refresca lista en parent
      onClose();        // cierra modal
    } catch (err: any) {
      console.error(err);
      toast.error(err.response?.data?.detail ?? "Error al crear producto");
    }
  }

  /* interfaz ---------------------------------------------------------------- */

  return (
    <Transition show={open} as={Fragment}>
      <Dialog
        onClose={() => {
          reset();
          onClose();
        }}
        className="relative z-50"
      >
        {/* backdrop */}
        <Transition.Child
          as={Fragment}
          enter="ease-out duration-200"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-150"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className="fixed inset-0 bg-black/40 backdrop-blur-sm" />
        </Transition.Child>

        {/* panel */}
        <div className="fixed inset-0 grid place-items-center p-4">
          <Transition.Child
            as={Fragment}
            enter="ease-out duration-200"
            enterFrom="scale-95 opacity-0"
            enterTo="scale-100 opacity-100"
            leave="ease-in duration-150"
            leaveFrom="scale-100 opacity-100"
            leaveTo="scale-95 opacity-0"
          >
            <Dialog.Panel className="max-w-2xl w-full overflow-hidden rounded-xl bg-white shadow-xl">
              {/* header */}
              <div className="flex items-center justify-between border-b px-6 py-4">
                <Dialog.Title className="text-lg font-semibold">
                  Nuevo producto
                </Dialog.Title>
                <button
                  className="rounded p-1 text-gray-500 hover:bg-gray-100"
                  onClick={() => {
                    reset();
                    onClose();
                  }}
                >
                  <XMarkIcon className="h-5 w-5" />
                </button>
              </div>

              {/* form */}
              <form
                onSubmit={handleSubmit(onSubmit)}
                className="grid gap-6 px-6 py-8 md:grid-cols-2"
              >
                {/* ---- columna 1 ---- */}
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium">Nombre</label>
                    <input
                      {...register("name")}
                      className="form-input mt-1 w-full"
                      placeholder="Taladro Bosch 800 W"
                    />
                    {errors.name && (
                      <p className="text-xs text-red-600">
                        {errors.name.message}
                      </p>
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-medium">
                      Descripci√≥n
                    </label>
                    <textarea
                      {...register("description")}
                      rows={5}
                      className="form-input mt-1 w-full resize-none"
                      placeholder="A√±ade detalles t√©cnicos, estado, accesorios incluidos‚Ä¶"
                    />
                    {errors.description && (
                      <p className="text-xs text-red-600">
                        {errors.description.message}
                      </p>
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-medium">
                      Precio / hora (‚Ç¨)
                    </label>
                    <input
                      {...register("price_per_h")}
                      className="form-input mt-1 w-full"
                      placeholder="3.5"
                      inputMode="decimal"
                    />
                    {errors.price_per_h && (
                      <p className="text-xs text-red-600">
                        {errors.price_per_h.message}
                      </p>
                    )}
                  </div>
                </div>

                {/* ---- columna 2 ---- */}
                <div className="space-y-4">
                  {/* imagen ------------------------------------------------ */}
                  <div>
                    <label className="block text-sm font-medium">Imagen</label>

                    <label className="mt-1 flex h-48 w-full cursor-pointer items-center justify-center rounded border-2 border-dashed border-gray-300 text-sm text-gray-500 hover:border-brand hover:text-brand">
                      {preview ? (
                        <img
                          src={preview}
                          alt="preview"
                          className="h-full w-full object-cover"
                        />
                      ) : (
                        <span className="flex flex-col items-center gap-1">
                          <PhotoIcon className="h-8 w-8" />
                          <span>PNG, JPG, m√°x. 5 MB</span>
                        </span>
                      )}
                      <input
                        type="file"
                        accept="image/*"
                        className="sr-only"
                        onChange={e =>
                          setValue("image", e.target.files?.[0] as File)
                        }
                      />
                    </label>
                    {errors.image && (
                      <p className="text-xs text-red-600">
                        {errors.image.message}
                      </p>
                    )}
                  </div>

                  {/* categor√≠as ------------------------------------------ */}
                  <div>
                    <p className="mb-1 text-sm font-medium">Categor√≠as</p>
                    <div className="flex flex-wrap gap-2">
                      {cats.map((c: Category) => {
                        const selected = watch("categories").includes(c.id);
                        return (
                          <button
                            type="button"
                            key={c.id}
                            onClick={() => {
                              const current = new Set(watch("categories"));
                              selected
                                ? current.delete(c.id)
                                : current.add(c.id);
                              setValue("categories", [...current]);
                            }}
                            className={
                              selected
                                ? "rounded-full bg-brand px-3 py-0.5 text-xs text-white"
                                : "rounded-full border px-3 py-0.5 text-xs text-gray-600"
                            }
                          >
                            {c.name}
                          </button>
                        );
                      })}
                    </div>
                    {errors.categories && (
                      <p className="text-xs text-red-600">
                        {errors.categories.message}
                      </p>
                    )}
                  </div>
                </div>

                {/* ---- footer ---- */}
                <div className="md:col-span-2 flex justify-end gap-3">
                  <button
                    type="button"
                    className="btn--ghost"
                    onClick={() => {
                      reset();
                      onClose();
                    }}
                  >
                    Cancelar
                  </button>
                  <button className="btn" disabled={isSubmitting}>
                    Publicar
                  </button>
                </div>
              </form>
            </Dialog.Panel>
          </Transition.Child>
        </div>
      </Dialog>
    </Transition>
  );
}


--- rental-mvp/frontend/src/features/items/ItemList.tsx ---
import { useEffect, useMemo, useRef, useState } from 'react';
import axios from 'axios';
import Container from '../../components/shared/Container';
import ItemCard from '../../components/ui/ItemCard';
import SkeletonCard from '../../components/ui/SkeletonCard';
import FiltersSidebar from '../../components/filters/FiltersSidebar';
import { useItems } from './useItems';
import { useAuth } from '../../hooks/useAuth';
import AddItemModal from './AddItemModal';

type FiltersT = {
  name?: string;
  min_price?: number;
  max_price?: number;
  categories?: number[];
  order?: 'price_asc' | 'price_desc' | 'name';
};

export default function ItemList() {
  /* ------------------------------ filtros ------------------------------ */
  const [filters, setFilters] = useState<FiltersT>({});
  const params = useMemo(() => {
    const p = new URLSearchParams();
    Object.entries(filters).forEach(([k, v]) => {
      if (v === undefined || v === '') return;
      if (Array.isArray(v)) v.forEach(val => p.append(k, String(val)));
      else p.set(k, String(v));
    });
    // orden
    if (filters.order) {
      const [field, dir] = filters.order.split('_');
      p.set('order_by', field === 'price' ? 'price' : 'name');
      p.set('order_dir', dir);
    }
    return p;
  }, [filters]);

  const { data: items, loading, refetch } = useItems(params);
  const { token } = useAuth();

  /* ----------------------- infinite scroll demo ----------------------- */
  const sentinel = useRef<HTMLDivElement>(null);
  useEffect(() => {
    if (!sentinel.current) return;
    const ob = new IntersectionObserver(
      entries => {
        if (entries[0].isIntersecting && !loading) {
          // aqu√≠ podr√≠as aumentar skip y llamar a refetch, si tu API lo soporta
        }
      },
      { rootMargin: '600px' }
    );
    ob.observe(sentinel.current);
    return () => ob.disconnect();
  }, [loading]);

  /* ---------------------- modal de nuevo √≠tem ------------------------- */
  const [open, setOpen] = useState(false);

  /* demo r√°pido original (se mantiene oculto) --------------------------- */
  async function handleAdd(name: string, price: number) {
    if (!token) return;
    await axios.post(
      '/api/items/',
      { name, price_per_h: price },
      { headers: { Authorization: `Bearer ${token}` } }
    );
    refetch();
  }

  return (
    <Container>
      <div className="flex gap-10">
        {/* -------- Sidebar -------- */}
        <FiltersSidebar
          value={filters}
          onChange={setFilters}
          onReset={() => setFilters({})}
        />

        {/* -------- Listado -------- */}
        <section className="flex-1">
          {/* bot√≥n a√±adir */}
          {token && (
            <div className="flex justify-end">
              <button className="btn mb-4" onClick={() => setOpen(true)}>
                A√±adir producto
              </button>
            </div>
          )}

          {loading && !items.length ? (
            <GridSkeleton />
          ) : (
            <Grid>
              {items.map(it => (
                <ItemCard key={it.id} item={it} />
              ))}
              {/* sentinel */}
              <div ref={sentinel} />
            </Grid>
          )}

          {!loading && !items.length && (
            <p className="py-6 text-center text-gray-500">
              No hay resultados.
            </p>
          )}
        </section>
      </div>

      {/* modal */}
      <AddItemModal
        open={open}
        onClose={() => setOpen(false)}
        onCreated={refetch}
      />
    </Container>
  );
}

/* ---------- helpers ---------- */
const Grid = ({ children }: { children: React.ReactNode }) => (
  <div
    className="grid justify-center                 /* centra cuando sobran huecos */
           grid-cols-[repeat(auto-fill,minmax(15rem,1fr))]
           gap-6 py-6"
  >
    {children}
  </div>
);

const GridSkeleton = () => (
  <Grid>
    {Array.from({ length: 8 }).map((_, i) => (
      <SkeletonCard key={i} />
    ))}
  </Grid>
);


--- rental-mvp/frontend/src/features/rentals/RentalList.tsx ---
import { useAuth } from "../../hooks/useAuth";
import { useRentals } from "./useRentals";

export default function RentalList() {
  const { token } = useAuth();
  const { data: rentals, loading } = useRentals(token);

  if (!token) return <p className="text-gray-500">Debes iniciar sesi√≥n para ver tus alquileres.</p>;
  if (loading) return <p className="text-gray-500">Cargando‚Ä¶</p>;
  if (!rentals.length) return <p className="text-gray-500">No tienes alquileres activos.</p>;

  return (
    <div className="space-y-2">
      {rentals.map(r => (
        <div key={r.id} className="flex items-center justify-between rounded-md bg-white p-3 shadow">
          <span className="font-medium">{r.item.name}</span>
          <span className={r.returned ? 'badge--ok' : 'badge badge--danger'}>
            {r.returned ? 'Devuelto' : 'Pendiente'}
          </span>
        </div>
      ))}
    </div>
  );
}


--- rental-mvp/frontend/src/features/rentals/useRentals.ts ---
import axios from "axios";
import { useEffect, useState } from "react";
import { Item } from "../items/useItems";

export type Rental = {
  id: number;
  item: Item;
  start_at: string;
  end_at: string;
  deposit: number;
  returned: boolean;
};

export function useRentals(token: string | null) {
  const [data, setData] = useState<Rental[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!token) return;
    setLoading(true);
    axios
      .get<Rental[]>("/api/rentals/me", {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => setData(res.data))
      .finally(() => setLoading(false));
  }, [token]);

  return { data, loading };
}


--- rental-mvp/frontend/src/pages/Register.tsx ---
// src/pages/Register.tsx
import { useForm } from "react-hook-form";
import { z } from "zod";
import { zodResolver } from "@hookform/resolvers/zod";
import zxcvbn from "zxcvbn";
import { useNavigate } from "react-router-dom";
import toast from "react-hot-toast";
import clsx from "clsx";

import { register as apiRegister } from "../features/auth/register";
import { login as apiLogin } from "../features/auth/login";
import { useAuth } from "../hooks/useAuth";

import Container from "../components/shared/Container";
import SocialButton from "../components/ui/SocialButton";
import { FcGoogle } from "react-icons/fc";
import { FaGithub } from "react-icons/fa";

/* -------- validation schema -------- */
const schema = z
  .object({
    username: z.string().min(3, "M√≠n. 3 caracteres"),
    email: z.string().email("Email inv√°lido"),
    password: z.string().min(8, "M√≠n. 8 caracteres"),
    confirm: z.string(),
    terms: z.literal(true, {
      errorMap: () => ({ message: "Acepta los t√©rminos" }),
    }),
  })
  .refine(data => data.password === data.confirm, {
    message: "Las contrase√±as no coinciden",
    path: ["confirm"],
  });

type FormData = z.infer<typeof schema>;

export default function Register() {
  const navigate = useNavigate();
  const { login: saveToken } = useAuth();

  const {
    register,
    handleSubmit,
    watch,
    formState: { errors, isSubmitting },
  } = useForm<FormData>({ resolver: zodResolver(schema) });

  const pwd = watch("password", "");

  /* -------------------------------------------------------------------- */
  const onSubmit = async (data: FormData) => {
    try {
      // 1) signup
      await apiRegister(data.username, data.email, data.password);

      // 2) auto-login
      const token = await apiLogin(data.username, data.password);
      saveToken(token);

      toast.success("Cuenta creada, ¬°bienvenido!");
      navigate("/dashboard");
    } catch (err: any) {
      // FastAPI devuelve detail en .response.data.detail
      const msg =
        err?.response?.data?.detail ??
        "No se pudo crear la cuenta. Int√©ntalo m√°s tarde.";
      toast.error(msg);
    }
  };

  /* -------------------------------------------------------------------- */
  const strength = zxcvbn(pwd).score; // 0-4

  return (
    <Container>
      <main className="flex min-h-[70vh] items-center justify-center">
        <div className="w-full max-w-md space-y-6 rounded-xl bg-white p-8 shadow-card">
          <h1 className="text-center text-2xl font-bold">Crear cuenta</h1>

          {/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ login social ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
          <div className="space-y-3">
            <SocialButton provider="google" icon={FcGoogle} label="Con Google" />
            <SocialButton provider="github" icon={FaGithub} label="Con GitHub" />
          </div>

          <div className="relative text-xs text-gray-400">
            <hr />
            <span className="absolute left-1/2 top-1/2 -translate-x-1/2 bg-white px-2">
              o reg√≠strate con email
            </span>
          </div>

          {/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ formulario ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            <input
              {...register("username")}
              placeholder="Nombre de usuario"
              className="form-input w-full"
            />
            {errors.username && (
              <p className="text-xs text-red-600">{errors.username.message}</p>
            )}

            <input
              {...register("email")}
              type="email"
              placeholder="Email"
              className="form-input w-full"
            />
            {errors.email && (
              <p className="text-xs text-red-600">{errors.email.message}</p>
            )}

            <input
              {...register("password")}
              type="password"
              placeholder="Contrase√±a"
              className="form-input w-full"
            />

            {/* strength meter */}
            {pwd && (
              <div className="h-2 w-full overflow-hidden rounded bg-gray-200">
                <div
                  style={{ width: `${(strength + 1) * 20}%` }}
                  className={clsx(
                    "h-full transition-all",
                    [
                      "bg-red-500",
                      "bg-orange-400",
                      "bg-yellow-400",
                      "bg-lime-500",
                      "bg-green-600",
                    ][strength],
                  )}
                />
              </div>
            )}
            {errors.password && (
              <p className="text-xs text-red-600">
                {errors.password.message}
              </p>
            )}

            <input
              {...register("confirm")}
              type="password"
              placeholder="Repite contrase√±a"
              className="form-input w-full"
            />
            {errors.confirm && (
              <p className="text-xs text-red-600">{errors.confirm.message}</p>
            )}

            {/* terms */}
            <label className="flex gap-2 text-xs text-gray-600">
              <input type="checkbox" {...register("terms")} />
              Acepto los&nbsp;
              <a href="/terms" className="text-brand hover:underline">
                T√©rminos y la Pol√≠tica de privacidad
              </a>
            </label>
            {errors.terms && (
              <p className="text-xs text-red-600">{errors.terms.message}</p>
            )}

            <button className="btn w-full" disabled={isSubmitting}>
              {isSubmitting ? "Creando‚Ä¶" : "Crear cuenta"}
            </button>
          </form>
        </div>
      </main>
    </Container>
  );
}


--- rental-mvp/frontend/src/pages/Login.tsx ---
// src/pages/Login.tsx
import { FormEvent, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';
import { login as apiLogin } from '../features/auth/login';

import { FcGoogle } from 'react-icons/fc';
import { FaGithub } from 'react-icons/fa';
import SocialButton from '../components/ui/SocialButton';
import Container from '../components/shared/Container';
import toast from 'react-hot-toast';  

export default function Login() {
  const [user, setUser] = useState('');
  const [pwd, setPwd] = useState('');
  const [error, setError] = useState<string | null>(null);

  const { login: saveToken } = useAuth();
  const nav = useNavigate();

  async function handleSubmit(e: FormEvent) {
    e.preventDefault();
    try {
  const token = await apiLogin(user, pwd);
  saveToken(token);
  nav('/dashboard');
  toast.success('¬°Bienvenido de nuevo!');            // üÜï
} catch {
  toast.error('Usuario o contrase√±a incorrectos');   // üÜï
}
  }

  return (
    <Container>
      <main className="flex min-h-[70vh] items-center justify-center">
        <div className="w-full max-w-md space-y-6 rounded-xl bg-white p-8 shadow-card">
          {/* T√≠tulo */}
          <h1 className="text-center text-2xl font-bold">Iniciar sesi√≥n</h1>

          {/* Social login */}
          <div className="space-y-3">
            <SocialButton
              provider="google"
              icon={FcGoogle}
              label="Entrar con Google"
            />
            <SocialButton
              provider="github"
              icon={FaGithub}
              label="Entrar con GitHub"
            />
          </div>

          <div className="relative">
            <hr />
            <span className="absolute left-1/2 top-1/2 -translate-x-1/2 bg-white px-2 text-xs text-gray-400">
              o contin√∫a con tu cuenta
            </span>
          </div>

          {/* Form tradicional */}
          {error && <p className="text-center text-sm text-red-600">{error}</p>}
          <form onSubmit={handleSubmit} className="space-y-4">
            <input
              className="form-input w-full"
              placeholder="Usuario"
              value={user}
              onChange={e => setUser(e.target.value)}
              required
            />
            <input
              className="form-input w-full"
              type="password"
              placeholder="Contrase√±a"
              value={pwd}
              onChange={e => setPwd(e.target.value)}
              required
            />
            <button className="btn w-full">Entrar</button>
          </form>

          <p className="text-center text-xs text-gray-500">
            ¬øNo tienes cuenta?{' '}
            <a href="/register" className="font-medium text-brand hover:underline">
              Reg√≠strate
            </a>
          </p>
        </div>
      </main>
    </Container>
  );
}


--- rental-mvp/frontend/src/pages/Dashboard.tsx ---
import Container from '../components/shared/Container';
import ItemList from '../features/items/ItemList';
import RentalList from '../features/rentals/RentalList';
import Section from '../components/shared/Section';

export default function Dashboard() {
  return (
    <Container>
      <Section title="Mis alquileres">
        <RentalList />
      </Section>

      <Section title="Cat√°logo p√∫blico">
        <ItemList />
      </Section>
    </Container>
  );
}


--- rental-mvp/frontend/src/pages/Home.tsx ---
import { Link } from 'react-router-dom';
import { ArrowRightIcon } from '@heroicons/react/24/solid';
import Container from '../components/shared/Container';
import Section from '../components/shared/Section';

export default function Home() {
  return (
    <>
      {/* HERO */}
      <section className="relative overflow-hidden bg-brand text-white">
        <Container>
          <div className="flex min-h-[60vh] flex-col items-center justify-center gap-6 py-24 text-center">
            <h1 className="max-w-3xl text-balance text-5xl font-extrabold leading-tight">
              Alquila y gana dinero con tus herramientas que no usas a diario
            </h1>
            <p className="max-w-xl text-lg/relaxed text-white/90">
              Conecta con gente de tu zona, protege tus transacciones y ahorra comprando.
            </p>
            <Link to="/dashboard" className="btn inline-flex gap-2">
              Explorar cat√°logo <ArrowRightIcon className="h-5 w-5" />
            </Link>
          </div>
        </Container>
      </section>

      {/* HOW IT WORKS */}
      <Section title="¬øC√≥mo funciona?">
        <Container>
          <div className="grid gap-12 md:grid-cols-3">
            {[
              ['Publica', 'Sube tu producto y fija tu precio.'],
              ['Reserva', 'Los usuarios reservan y pagan la fianza.'],
              ['Gana', 'Entrega el √≠tem y recibe tu dinero.']
            ].map(([t, d]) => (
              <div key={t} className="space-y-3 text-center">
                <div className="mx-auto h-12 w-12 rounded-full bg-brand/10" />
                <h3 className="text-xl font-semibold">{t}</h3>
                <p className="text-gray-600">{d}</p>
              </div>
            ))}
          </div>
        </Container>
      </Section>
    </>
  );
}


--- rental-mvp/frontend/src/components/ui/SkeletonCard.tsx ---
export default function SkeletonCard() {
  return (
    <div className="overflow-hidden rounded-lg bg-white shadow-card">
      <div className="aspect-[4/3] w-full animate-pulse bg-gray-200" />
      <div className="space-y-2 p-4">
        <div className="h-4 w-2/3 animate-pulse rounded bg-gray-200" />
        <div className="h-4 w-1/3 animate-pulse rounded bg-gray-200" />
      </div>
    </div>
  );
}


--- rental-mvp/frontend/src/components/ui/LazyImage.tsx ---
// frontend/src/components/ui/LazyImage.tsx
import { useState } from 'react';

type Props = { src: string; alt: string; className?: string };

export default function LazyImage({ src, alt, className = '' }: Props) {
  const [loaded, setLoaded] = useState(false);

  return (
    <img
      src={src}                       // ‚Üê SIEMPRE el src real
      loading="lazy"
      onLoad={() => setLoaded(true)}  // cuando acabe, quitamos fade-in
      className={`${className} transition-opacity duration-500 ${
        loaded ? 'opacity-100' : 'opacity-0'
      }`}
      alt={alt}
    />
  );
}


--- rental-mvp/frontend/src/components/ui/ItemCard.tsx ---
import { useState } from 'react';
import { Item } from '../../features/items/useItems';
import LazyImage from './LazyImage';
import { resolveImage } from '../../utils';
import QuickViewModal from './QuickViewModal';
import clsx from 'clsx';
import { HeartIcon, EyeIcon } from '@heroicons/react/24/solid';

export default function ItemCard({ item }: { item: Item }) {
  const [open, setOpen] = useState(false);

  /* URL de la imagen: si el √≠tem trae `image_url` usamos esa;
     si no, caemos al placeholder de Unsplash. */
  const imgSrc = resolveImage(
    item.image_url,
    `https://source.unsplash.com/640x480/?${encodeURIComponent(item.name)}`
  );

  return (
    <>
      {/* max-w para que nunca ‚Äúreviente‚Äù el layout si solo hay 1 tarjeta */}
      <article
        className="group flex w-full max-w-[15rem] flex-col overflow-hidden
                   rounded-lg bg-surface shadow-card transition-transform duration-200
                   hover:-translate-y-1 hover:shadow-cardHover mx-auto"
      >
        {/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Imagen + overlays ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
        <div
          className="relative cursor-pointer"
          onClick={() => setOpen(true)}
        >
          <LazyImage
            src={imgSrc}
            alt={item.name}
            className="aspect-[4/3] w-full object-cover"
          />

          {/* badge ‚ÄúAlquilado‚Äù */}
          {!item.available && (
            <span className="absolute left-0 top-0 rounded-br-md bg-red-600/90 px-2 py-0.5 text-xs font-semibold uppercase tracking-wide text-white">
              Alquilado
            </span>
          )}

          {/* Quick-view & wishlist (hover) */}
          <div className="absolute inset-0 flex items-start justify-end gap-2 p-2 opacity-0 transition-opacity group-hover:opacity-100">
            <IconBtn title="Vista r√°pida" onClick={() => setOpen(true)}>
              <EyeIcon className="h-5 w-5" />
            </IconBtn>
            <IconBtn title="Favorito">
              <HeartIcon className="h-5 w-5" />
            </IconBtn>
          </div>
        </div>

        {/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Contenido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
        <div className="flex flex-1 flex-col gap-2 p-4">
          <h3 className="line-clamp-1 text-lg font-semibold text-gray-900">
            {item.name}
          </h3>

          {item.description && (
            <p className="line-clamp-2 text-sm text-gray-600">
              {item.description}
            </p>
          )}

          <div className="mt-auto flex items-center justify-between">
            <p className="text-base font-bold text-brand">
              {item.price_per_h.toFixed(2)} ‚Ç¨/h
            </p>
            <span
              className={clsx(
                'badge',
                item.available ? 'badge--ok' : 'badge--danger'
              )}
            >
              {item.available ? 'Disponible' : 'Alquilado'}
            </span>
          </div>
        </div>
      </article>

      {/* Modal */}
      <QuickViewModal open={open} onClose={() => setOpen(false)} item={item} />
    </>
  );
}

/* helper bot√≥n overlay */
function IconBtn({
  children,
  onClick,
  title
}: {
  children: React.ReactNode;
  onClick?: () => void;
  title: string;
}) {
  return (
    <button
      type="button"
      title={title}
      onClick={e => {
        e.stopPropagation();
        onClick?.();
      }}
      className="rounded-full bg-white/90 p-1 text-gray-600 shadow transition-colors hover:bg-white"
    >
      {children}
    </button>
  );
}


--- rental-mvp/frontend/src/components/ui/SearchBar.tsx ---
import { useForm } from 'react-hook-form';

type Props = { onSubmit: (q: URLSearchParams) => void };

export default function SearchBar({ onSubmit }: Props) {
  const { register, handleSubmit, reset } = useForm<{
    q: string;
    min: number | undefined;
    max: number | undefined;
  }>({ defaultValues: { q: '', min: undefined, max: undefined } });

  return (
    <form
      onSubmit={handleSubmit(values => {
        const params = new URLSearchParams();
        if (values.q) params.set('name', values.q);
        if (values.min) params.set('min_price', values.min.toString());
        if (values.max) params.set('max_price', values.max.toString());
        onSubmit(params);
      })}
      className="flex flex-wrap items-end gap-3"
    >
      <input
        {...register('q')}
        placeholder="Buscar producto‚Ä¶"
        className="form-input w-52"
      />
      <input
        {...register('min', { valueAsNumber: true })}
        type="number"
        step="0.1"
        min={0}
        placeholder="‚Ç¨ m√≠nimo"
        className="form-input w-32"
      />
      <input
        {...register('max', { valueAsNumber: true })}
        type="number"
        step="0.1"
        min={0}
        placeholder="‚Ç¨ m√°ximo"
        className="form-input w-32"
      />
      <button className="btn">Filtrar</button>
      <button
        type="button"
        onClick={() => {
          reset();
          onSubmit(new URLSearchParams());
        }}
        className="btn--ghost"
      >
        Limpiar
      </button>
    </form>
  );
}


--- rental-mvp/frontend/src/components/ui/SocialButton.tsx ---
// src/components/ui/SocialButton.tsx
import { IconType } from 'react-icons';
import clsx from 'clsx';

type Props = {
  icon: IconType;
  label: string;
  provider: 'google' | 'github';
};

export default function SocialButton({ icon: Icon, label, provider }: Props) {
  return (
    <a
      href={`/api/oauth/${provider}`}           /* El backend redirige al proveedor */
      className={clsx(
        'btn flex w-full items-center justify-center gap-2',
        provider === 'google' && 'bg-white text-gray-700 shadow border hover:bg-gray-50',
        provider === 'github' && 'bg-gray-900 text-white hover:bg-gray-800'
      )}
    >
      <Icon className="h-5 w-5" />
      {label}
    </a>
  );
}


--- rental-mvp/frontend/src/components/ui/QuickViewModal.tsx ---
import { Fragment } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { XMarkIcon, StarIcon } from '@heroicons/react/24/outline';
import { Item } from '../../features/items/useItems';
import LazyImage from './LazyImage';
import { resolveImage } from '../../utils';
import clsx from 'clsx';

type Props = {
  open: boolean;
  onClose: () => void;
  item: Item | null;
};

export default function QuickViewModal({ open, onClose, item }: Props) {
  if (!item) return null;

  /* Imagen grande: preferimos la subida; fallback Unsplash. */
  const imgSrc = resolveImage(
    item.image_url,
    `https://source.unsplash.com/800x600/?${encodeURIComponent(item.name)}`
  );

  return (
    <Transition show={open} as={Fragment}>
      <Dialog onClose={onClose} className="relative z-50">
        {/* backdrop */}
        <Transition.Child
          as={Fragment}
          enter="ease-out duration-200"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-150"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className="fixed inset-0 bg-black/40 backdrop-blur-sm" />
        </Transition.Child>

        {/* panel */}
        <div className="fixed inset-0 grid place-items-center p-4">
          <Transition.Child
            as={Fragment}
            enter="ease-out duration-200"
            enterFrom="scale-95 opacity-0"
            enterTo="scale-100 opacity-100"
            leave="ease-in duration-150"
            leaveFrom="scale-100 opacity-100"
            leaveTo="scale-95 opacity-0"
          >
            <Dialog.Panel className="max-w-3xl overflow-hidden rounded-xl bg-white shadow-xl">
              {/* header */}
              <div className="flex items-center justify-between border-b p-4">
                <Dialog.Title className="text-lg font-semibold">
                  {item.name}
                </Dialog.Title>
                <button
                  className="rounded p-1 text-gray-500 hover:bg-gray-100"
                  onClick={onClose}
                >
                  <XMarkIcon className="h-5 w-5" />
                </button>
              </div>

              <div className="grid gap-6 p-6 md:grid-cols-2">
                {/* image */}
                <LazyImage
                  src={imgSrc}
                  alt={item.name}
                  className="aspect-video w-full rounded-lg object-cover"
                />

                {/* info */}
                <div className="flex flex-col gap-4">
                  {/* price */}
                  <p className="text-2xl font-bold text-brand">
                    {item.price_per_h.toFixed(2)} ‚Ç¨/h
                  </p>

                  {/* rating DEMO */}
                  <div className="flex items-center gap-1">
                    {Array.from({ length: 5 }).map((_, i) => (
                      <StarIcon
                        key={i}
                        className={clsx(
                          'h-5 w-5',
                          i < 4
                            ? 'fill-amber-400 stroke-amber-400'
                            : 'stroke-gray-300'
                        )}
                      />
                    ))}
                    <span className="ml-1 text-sm text-gray-500">(4,0)</span>
                  </div>

                  {/* description */}
                  {item.description ? (
                    <p className="prose max-w-none text-sm leading-relaxed line-clamp-[10]">
                      {item.description}
                    </p>
                  ) : (
                    <p className="text-sm text-gray-500">Sin descripci√≥n.</p>
                  )}

                  {/* categories */}
                  {item.categories?.length && (
                    <div className="flex flex-wrap gap-2">
                      {item.categories.map(c => (
                        <span
                          key={c.id}
                          className="rounded-full bg-gray-100 px-3 py-0.5 text-xs text-gray-600"
                        >
                          {c.name}
                        </span>
                      ))}
                    </div>
                  )}

                  {/* CTA */}
                  <button className="btn mt-auto w-full">Reservar ahora</button>
                </div>
              </div>
            </Dialog.Panel>
          </Transition.Child>
        </div>
      </Dialog>
    </Transition>
  );
}


--- rental-mvp/frontend/src/components/shared/Section.tsx ---
type Props = {
  title?: string;
  children: React.ReactNode;
  id?: string;
};

export default function Section({ title, children, id }: Props) {
  return (
    <section id={id} className="space-y-6 py-16">
      {title && (
        <h2 className="text-center text-3xl font-bold tracking-tight">{title}</h2>
      )}
      {children}
    </section>
  );
}


--- rental-mvp/frontend/src/components/shared/Container.tsx ---
export default function Container({ children }: { children: React.ReactNode }) {
  return <div className="container">{children}</div>;
}


--- rental-mvp/frontend/src/components/layout/Footer.tsx ---
export default function Footer() {
  return (
    <footer className="mt-24 border-t bg-white py-12 text-center text-sm text-gray-500">
      Rental‚ÄëMVP ¬© {new Date().getFullYear()} ¬∑ Hecho con‚ÄØ‚ù§ en FastAPI¬†+¬†React
    </footer>
  );
}


--- rental-mvp/frontend/src/components/layout/Header.tsx ---
import { Link, NavLink } from 'react-router-dom';
import { useAuth } from '../../hooks/useAuth';
import { Bars3Icon } from '@heroicons/react/24/outline';

export default function Header() {
  const { token, logout } = useAuth();
  return (
    <header className="sticky top-0 z-30 bg-white/80 backdrop-blur shadow-sm">
      <div className="container flex h-14 items-center gap-6">
        <Link to="/" className="flex items-center gap-1 text-lg font-bold text-brand">
          <Bars3Icon className="h-6 w-6" />
          Rental‚ÄëMVP
        </Link>

        <nav className="ml-auto flex gap-6 text-sm font-semibold text-gray-600">
          {token ? (
            <>
              <NavLink to="/dashboard" className="hover:text-gray-900">
                Dashboard
              </NavLink>
              <button onClick={logout} className="hover:text-gray-900">
                Salir
              </button>
            </>
          ) : (
            <NavLink to="/login" className="hover:text-gray-900">
              Login
            </NavLink>
          )}
        </nav>
      </div>
    </header>
  );
}


--- rental-mvp/frontend/src/components/filters/FiltersSidebar.tsx ---
import { Disclosure } from '@headlessui/react';
import useCategories, { Category } from '../../features/categories/useCategories';

type Filters = {
  name?: string;
  min_price?: number;
  max_price?: number;
  categories?: number[];
  order?: 'price_asc' | 'price_desc' | 'name';
};

type Props = {
  value: Filters;
  onChange: (f: Filters) => void;
  onReset: () => void;
};

export default function FiltersSidebar({ value, onChange, onReset }: Props) {
  const { data: cats } = useCategories();

  const toggleCat = (id: number) => {
    const list = new Set(value.categories ?? []);
    list.has(id) ? list.delete(id) : list.add(id);
    onChange({ ...value, categories: [...list] });
  };

  return (
    <aside className="w-full max-w-xs space-y-6 md:w-60 lg:w-72">
      {/* Search */}
      <input
        placeholder="Buscar‚Ä¶"
        className="form-input w-full"
        value={value.name ?? ''}
        onChange={e => onChange({ ...value, name: e.target.value || undefined })}
      />

      {/* Price */}
      <Disclosure defaultOpen>
        {({ open }) => (
          <>
            <Disclosure.Button className="flex w-full justify-between text-sm font-semibold">
              Precio {open ? '‚àí' : '+'}
            </Disclosure.Button>
            <Disclosure.Panel className="mt-3 space-y-2">
              <input
                type="number"
                min={0}
                step={0.1}
                placeholder="m√≠n"
                className="form-input w-full"
                value={value.min_price ?? ''}
                onChange={e =>
                  onChange({
                    ...value,
                    min_price: e.target.value ? Number(e.target.value) : undefined
                  })
                }
              />
              <input
                type="number"
                min={0}
                step={0.1}
                placeholder="m√°x"
                className="form-input w-full"
                value={value.max_price ?? ''}
                onChange={e =>
                  onChange({
                    ...value,
                    max_price: e.target.value ? Number(e.target.value) : undefined
                  })
                }
              />
            </Disclosure.Panel>
          </>
        )}
      </Disclosure>

      {/* Categories */}
      <Disclosure defaultOpen>
        {({ open }) => (
          <>
            <Disclosure.Button className="flex w-full justify-between text-sm font-semibold">
              Categor√≠as {open ? '‚àí' : '+'}
            </Disclosure.Button>
            <Disclosure.Panel className="mt-3 flex flex-wrap gap-2">
              {cats.map((c: Category) => {
                const active = value.categories?.includes(c.id);
                return (
                  <button
                    key={c.id}
                    onClick={() => toggleCat(c.id)}
                    className={
                      active
                        ? 'rounded-full bg-brand px-3 py-0.5 text-xs font-medium text-white'
                        : 'rounded-full border px-3 py-0.5 text-xs text-gray-600'
                    }
                  >
                    {c.name}
                  </button>
                );
              })}
            </Disclosure.Panel>
          </>
        )}
      </Disclosure>

      {/* Order */}
      <select
        className="form-select w-full"
        value={value.order ?? ''}
        onChange={e =>
          onChange({
            ...value,
            order: e.target.value ? (e.target.value as Filters['order']) : undefined
          })
        }
      >
        <option value="">Ordenar por‚Ä¶</option>
        <option value="price_asc">Precio ‚Üë</option>
        <option value="price_desc">Precio ‚Üì</option>
        <option value="name">Nombre</option>
      </select>

      {/* Reset */}
      <button onClick={onReset} className="btn--ghost w-full">
        Limpiar filtros
      </button>
    </aside>
  );
}


--- rental-mvp/app/main.py ---
# app/main.py
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles          # üÜï

from app import models  # noqa: F401
from app.api import auth, items, rentals, categories, upload   # üÜï

app = FastAPI(title="rental-mvp")

# Routers
app.include_router(auth.router,       prefix="/api/auth",      tags=["auth"])
app.include_router(items.router,      prefix="/api/items",     tags=["items"])
app.include_router(rentals.router,    prefix="/api/rentals",   tags=["rentals"])
app.include_router(categories.router, prefix="/api/categories", tags=["categories"])
app.include_router(upload.router,     prefix="/api/upload",    tags=["upload"])  # üÜï

# ‚ñ∫ archivos subidos accesibles en /uploads/‚Ä¶
app.mount("/uploads", StaticFiles(directory="uploads"), name="uploads")         # üÜï


--- rental-mvp/app/deps.py ---
# app/deps.py
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from sqlalchemy.orm import Session
from jose import JWTError, jwt

from app.models.database import SessionLocal
from app.models.models import User
from app.core.config import settings

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/auth/token")

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def get_current_user(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)) -> User:
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="No se pudo validar las credenciales",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        payload = jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception

    user = db.query(User).filter(User.username == username).first()
    if user is None:
        raise credentials_exception
    return user


--- rental-mvp/app/models/models.py ---
from __future__ import annotations

import datetime
from sqlalchemy import (
    Boolean,
    Column,
    DateTime,
    Float,
    ForeignKey,
    Integer,
    String,
    Table,
)
from sqlalchemy.orm import relationship

from .database import Base

item_categories = Table(
    "item_categories",
    Base.metadata,
    Column("item_id", Integer, ForeignKey("items.id", ondelete="CASCADE"), primary_key=True),
    Column("category_id", Integer, ForeignKey("categories.id", ondelete="CASCADE"), primary_key=True),
)


class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    username = Column(String, unique=True, index=True, nullable=False)
    email = Column(String, unique=True, index=True, nullable=False)
    hashed_pw = Column(String, nullable=False)

    items = relationship("Item", back_populates="owner", cascade="all, delete-orphan")
    rentals = relationship("Rental", back_populates="renter", cascade="all, delete-orphan")


class Category(Base):
    __tablename__ = "categories"

    id = Column(Integer, primary_key=True)
    name = Column(String, unique=True, index=True, nullable=False)

    items = relationship("Item", secondary=item_categories, back_populates="categories")


class Item(Base):
    __tablename__ = "items"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, nullable=False)
    description = Column(String)
    price_per_h = Column(Float, nullable=False)

    image_url = Column(String, nullable=True)          # üÜï

    owner_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    owner = relationship("User", back_populates="items")

    available = Column(Boolean, default=True)

    # relaci√≥n n-n con categor√≠as   ‚Üê  lazy por defecto (‚Äúselect‚Äù): SIN JOIN
    categories = relationship(
        "Category",
        secondary=item_categories,
        back_populates="items",
    )


class Rental(Base):
    __tablename__ = "rentals"

    id = Column(Integer, primary_key=True, index=True)
    item_id = Column(Integer, ForeignKey("items.id"), nullable=False)
    renter_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    start_at = Column(DateTime, default=datetime.datetime.utcnow)
    end_at = Column(DateTime)

    deposit = Column(Float, nullable=False)
    returned = Column(Boolean, default=False)

    item = relationship("Item")
    renter = relationship("User", back_populates="rentals")


--- rental-mvp/app/models/__init__.py ---
# app/models/__init__.py
"""
Al importar `app.models` se registran todos los modelos en `Base.metadata`.
"""
from .models import User, Category, Item, Rental  # noqa: F401


--- rental-mvp/app/models/database.py ---
# app/models/database.py
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from app.core.config import settings

# Si usas SQLite hay que pasar connect_args
connect_args = {"check_same_thread": False} if settings.DATABASE_URL.startswith("sqlite") else {}

engine = create_engine(
    settings.DATABASE_URL,
    connect_args=connect_args,
    echo=True,  # ponte True en dev para ver SQL en consola
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()


--- rental-mvp/app/schemas/category.py ---
# app/schemas/category.py
from pydantic import BaseModel, Field


class CategoryBase(BaseModel):
    name: str = Field(..., min_length=1, max_length=50)


class CategoryCreate(CategoryBase):
    """Crear categor√≠a (solo nombre)."""
    pass


class CategoryOut(CategoryBase):
    id: int

    class Config:
        from_attributes = True


--- rental-mvp/app/schemas/rental.py ---
# app/schemas/rental.py
from datetime import datetime
from pydantic import BaseModel, field_validator


class RentalBase(BaseModel):
    item_id: int
    start_at: datetime
    end_at: datetime


class RentalCreate(RentalBase):
    """
    Al crear un alquiler nos aseguramos de que la hora de fin sea
    posterior a la hora de inicio.
    """

    @field_validator("end_at")
    def end_must_be_after_start(cls, v: datetime, info):
        start = info.data.get("start_at")
        if start and v <= start:
            raise ValueError("end_at debe ser posterior a start_at")
        return v

    model_config = {
        "json_schema_extra": {
            "examples": [
                {
                    "item_id": 42,
                    "start_at": "2025-01-01T10:00:00Z",
                    "end_at": "2025-01-01T12:00:00Z",
                }
            ]
        }
    }


class RentalOut(RentalBase):
    id: int
    renter_id: int
    deposit: float
    returned: bool

    class Config:
        from_attributes = True


--- rental-mvp/app/schemas/token.py ---
# app/schemas/token.py
from pydantic import BaseModel

class Token(BaseModel):
    access_token: str
    token_type: str = "bearer"


--- rental-mvp/app/schemas/__init__.py ---
# app/schemas/__init__.py
from .user import UserCreate, UserOut
from .category import CategoryCreate, CategoryOut
from .item import ItemCreate, ItemUpdate, ItemOut
from .rental import RentalCreate, RentalOut
from .token import Token

__all__ = [
    # users
    "UserCreate",
    "UserOut",
    # categories
    "CategoryCreate",
    "CategoryOut",
    # items
    "ItemCreate",
    "ItemUpdate",
    "ItemOut",
    # rentals
    "RentalCreate",
    "RentalOut",
    # auth
    "Token",
]


--- rental-mvp/app/schemas/item.py ---
# app/schemas/item.py
from __future__ import annotations
from typing import List, Optional

from pydantic import BaseModel, Field, PositiveFloat

from .category import CategoryOut


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Base ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class ItemBase(BaseModel):
    name: str = Field(..., min_length=1, max_length=80)
    description: Optional[str] = None
    price_per_h: PositiveFloat
    image_url: Optional[str] = Field(
        None,
        pattern=r"^https?://",          # validaci√≥n sencilla de URL p√∫blica
        description="URL p√∫blica de la imagen",
    )


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Crear (POST) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class ItemCreate(ItemBase):
    categories: Optional[List[int]] = Field(
        default=None,
        description="IDs de categor√≠as a asociar",
        examples=[[1, 2]],
    )

    model_config = {
        "json_schema_extra": {
            "examples": [
                {
                    "name": "Taladro Bosch",
                    "description": "800 W",
                    "price_per_h": 4.5,
                    "image_url": "https://‚Ä¶/foto.jpg",
                    "categories": [1, 2],
                }
            ]
        }
    }


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Actualizar (PATCH) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class ItemUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=1, max_length=80)
    description: Optional[str] = None
    price_per_h: Optional[PositiveFloat] = None
    image_url: Optional[str] = Field(
        None,
        pattern=r"^https?://",
        description="URL p√∫blica de la imagen",
    )
    categories: Optional[List[int]] = Field(
        default=None, description="Lista completa de IDs (reemplaza)"
    )

    model_config = {"extra": "forbid"}


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Salida ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class ItemOut(ItemBase):
    id: int
    owner_id: int
    available: bool
    categories: List[CategoryOut]

    class Config:
        from_attributes = True


--- rental-mvp/app/schemas/user.py ---
# app/schemas/user.py
from pydantic import BaseModel, EmailStr

class UserCreate(BaseModel):
    username: str
    email: EmailStr
    password: str


class UserOut(BaseModel):
    id: int
    username: str
    email: EmailStr

    class Config:              # <-- aqu√≠
        from_attributes = True


--- rental-mvp/app/crud/category.py ---
# app/crud/category.py
from typing import List, Optional

from sqlalchemy.orm import Session

from app.models.models import Category
from app.schemas.category import CategoryCreate


def get_category(db: Session, category_id: int) -> Optional[Category]:
    return db.query(Category).filter(Category.id == category_id).first()


def get_categories(db: Session) -> List[Category]:
    return db.query(Category).order_by(Category.name).all()


def create_category(db: Session, cat_in: CategoryCreate) -> Category:
    db_cat = Category(**cat_in.model_dump())
    db.add(db_cat)
    db.commit()
    db.refresh(db_cat)
    return db_cat


--- rental-mvp/app/crud/rental.py ---
# app/crud/rental.py
from decimal import Decimal, ROUND_HALF_UP
from datetime import datetime
from typing import List

from sqlalchemy.orm import Session

from app.models.models import Item, Rental
from app.schemas.rental import RentalCreate


def get_rental(db: Session, rental_id: int) -> Rental | None:
    return db.query(Rental).filter(Rental.id == rental_id).first()


def get_rentals_by_user(db: Session, renter_id: int) -> List[Rental]:
    return db.query(Rental).filter(Rental.renter_id == renter_id).all()


def create_rental(db: Session, renter_id: int, rent_in: RentalCreate) -> Rental:
    """Crea un alquiler y calcula el dep√≥sito como 120 % del coste estimado,
    redondeado a 2 decimales para evitar errores de coma flotante."""
    item = db.query(Item).get(rent_in.item_id)  # legacy API, suficiente aqu√≠
    hours = (rent_in.end_at - rent_in.start_at).total_seconds() / 3600
    estimated = hours * item.price_per_h

    deposit = float(                      # guardamos como float en la BD
        Decimal(estimated * 1.2).quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)
    )

    db_rental = Rental(
        renter_id=renter_id,
        deposit=deposit,
        returned=False,
        **rent_in.model_dump(),           # pydantic v2
    )

    db.add(db_rental)
    item.available = False
    db.commit()
    db.refresh(db_rental)
    return db_rental


def mark_returned(db: Session, rental: Rental) -> Rental:
    """Marca el alquiler como devuelto y vuelve a poner el √≠tem disponible."""
    rental.returned = True
    rental.item.available = True
    db.commit()
    db.refresh(rental)
    return rental


--- rental-mvp/app/crud/__init__.py ---
"""
Al importar ``app.crud`` re-exportamos helpers de todos los sub-m√≥dulos
para poder usarlos como ``crud.algo`` sin tener que encadenar paquetes.
"""

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ users ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
from .user import (           # noqa: F401  (re-export)
    get_user_by_username,
    get_user_by_email,        # üÜï
    create_user,
    verify_password,
)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ items ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
from .item import (           # noqa: F401
    get_item,
    get_items,
    get_items_by_owner,
    create_item,
    update_item,
    delete_item,
)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ rentals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
from .rental import (         # noqa: F401
    get_rental,
    get_rentals_by_user,
    create_rental,
    mark_returned,
)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ categories ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
from .category import (       # noqa: F401
    get_category,
    get_categories,
    create_category,
)

__all__: list[str] = [
    # users
    "get_user_by_username",
    "get_user_by_email",      # üÜï
    "create_user",
    "verify_password",
    # items
    "get_item",
    "get_items",
    "get_items_by_owner",
    "create_item",
    "update_item",
    "delete_item",
    # rentals
    "get_rental",
    "get_rentals_by_user",
    "create_rental",
    "mark_returned",
    # categories
    "get_category",
    "get_categories",
    "create_category",
]


--- rental-mvp/app/crud/item.py ---
# app/crud/item.py
from __future__ import annotations

from typing import List, Optional, Tuple

from sqlalchemy import or_, asc, desc
from sqlalchemy.orm import Session, joinedload

from app.models.models import Category, Item
from app.schemas.item import ItemCreate, ItemUpdate

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helpers privados ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


def _get_categories_or_400(db: Session, ids: list[int]) -> list[Category]:
    """
    Devuelve la lista de categor√≠as cuyo id est√© en *ids* o lanza ValueError
    si alguna no existe.
    """
    cats = db.query(Category).filter(Category.id.in_(ids)).all()
    if len(cats) != len(ids):
        missing = set(ids) - {c.id for c in cats}
        raise ValueError(f"Categor√≠a(s) inexistente(s): {', '.join(map(str, missing))}")
    return cats


def _apply_ordering(query, order_by: str | None, order_dir: str | None):
    """
    Aplica la ordenaci√≥n solicitada.  El frontend env√≠a:
      ¬∑ order_by  ‚àà {"price", "name"}
      ¬∑ order_dir ‚àà {"asc", "desc"}
    """
    if not order_by:
        return query  # sin ordenaci√≥n

    mapping = {
        "price": Item.price_per_h,
        "name": Item.name,
        "id": Item.id,  # comod√≠n por si acaso
    }
    column = mapping.get(order_by, Item.id)
    query = query.order_by(asc(column) if order_dir == "asc" else desc(column))
    return query


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Lectura ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


def get_item(db: Session, item_id: int) -> Optional[Item]:
    """Obtiene un √≠tem por id (con categor√≠as pre-cargadas)."""
    return (
        db.query(Item)
        .options(joinedload(Item.categories))
        .filter(Item.id == item_id)
        .first()
    )


def _build_items_query(
    db: Session,
    *,
    name: Optional[str] = None,
    min_price: Optional[float] = None,
    max_price: Optional[float] = None,
    available: Optional[bool] = None,
    categories: Optional[List[int]] = None,
    order_by: Optional[str] = None,
    order_dir: Optional[str] = None,
):
    """
    Crea la consulta base aplicando filtros din√°micos y la ordenaci√≥n.
    """
    q = db.query(Item).options(joinedload(Item.categories))

    # ‚îÄ‚îÄ filtros texto / rango precio / disponibilidad ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if name:
        pattern = f"%{name}%"
        q = q.filter(or_(Item.name.ilike(pattern), Item.description.ilike(pattern)))

    if min_price is not None:
        q = q.filter(Item.price_per_h >= min_price)

    if max_price is not None:
        q = q.filter(Item.price_per_h <= max_price)

    if available is not None:
        q = q.filter(Item.available == available)

    # ‚îÄ‚îÄ filtro por categor√≠as (al menos una coincidente) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if categories:
        q = q.filter(Item.categories.any(Category.id.in_(categories)))

    # ‚îÄ‚îÄ ordenaci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    q = _apply_ordering(q, order_by, order_dir)

    return q


def get_items(
    db: Session,
    skip: int = 0,
    limit: int = 100,
    *,
    name: Optional[str] = None,
    min_price: Optional[float] = None,
    max_price: Optional[float] = None,
    available: Optional[bool] = None,
    categories: Optional[List[int]] = None,
    order_by: Optional[str] = None,
    order_dir: Optional[str] = None,
) -> Tuple[List[Item], int]:
    """
    Devuelve la lista paginada de √≠tems junto con el total de resultados
    antes de la paginaci√≥n (para cabecera X-Total-Count).
    """
    q = _build_items_query(
        db,
        name=name,
        min_price=min_price,
        max_price=max_price,
        available=available,
        categories=categories,
        order_by=order_by,
        order_dir=order_dir,
    )
    total = q.count()
    items = q.offset(skip).limit(limit).all()
    return items, total


def get_items_by_owner(db: Session, owner_id: int) -> List[Item]:
    """
    Lista todos los √≠tems propiedad de *owner_id* (con categor√≠as).
    """
    return (
        db.query(Item)
        .options(joinedload(Item.categories))
        .filter(Item.owner_id == owner_id)
        .all()
    )


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Escritura ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


def create_item(db: Session, item_in: ItemCreate, owner_id: int) -> Item:
    """
    Crea un √≠tem y lo asocia al usuario *owner_id*.
    """
    db_item = Item(
        **item_in.model_dump(exclude={"categories"}),
        owner_id=owner_id,
    )

    if item_in.categories:
        db_item.categories = _get_categories_or_400(db, item_in.categories)

    db.add(db_item)
    db.commit()
    db.refresh(db_item)
    return db_item


def update_item(db: Session, item: Item, item_in: ItemUpdate) -> Item:
    """
    Actualiza los campos presentes en *item_in* (PATCH).
    """
    data = item_in.model_dump(exclude_unset=True, exclude={"categories"})
    for key, value in data.items():
        setattr(item, key, value)

    if item_in.categories is not None:
        item.categories = _get_categories_or_400(db, item_in.categories)

    db.commit()
    db.refresh(item)
    return item


def delete_item(db: Session, item: Item) -> None:
    """
    Elimina un √≠tem.
    """
    db.delete(item)
    db.commit()


--- rental-mvp/app/crud/user.py ---
# app/crud/user.py
from __future__ import annotations

import bcrypt
from passlib.context import CryptContext
from sqlalchemy.orm import Session

from app.models.models import User
from app.schemas.user import UserCreate

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helpers privados ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


def _hash_password(pwd: str) -> str:
    """Devuelve el hash seguro de *pwd* usando passlib/bcrypt."""
    return pwd_context.hash(pwd)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Lectura ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


def get_user_by_username(db: Session, username: str) -> User | None:
    """Busca un usuario por *username* (o None si no existe)."""
    return db.query(User).filter(User.username == username).first()


def get_user_by_email(db: Session, email: str) -> User | None:
    """Busca un usuario por email (o None si no existe)."""
    return db.query(User).filter(User.email == email).first()


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Escritura ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


def create_user(db: Session, user_in: UserCreate) -> User:
    """
    Crea un nuevo usuario con contrase√±a hasheada y lo devuelve.
    Lanza IntegrityError si el username/email ya existen.
    """
    db_user = User(
        username=user_in.username,
        email=user_in.email,
        hashed_pw=_hash_password(user_in.password),
    )
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Utilidades varias ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


def verify_password(plain_password: str, hashed_password: str) -> bool:
    """
    Comprueba que *plain_password* coincide con el hash almacenado.
    Se usa bcrypt directamente para evitar dependencias impl√≠citas.
    """
    try:
        return bcrypt.checkpw(plain_password.encode(), hashed_password.encode())
    except Exception:  # noqa: BLE001
        # bcrypt lanza ValueError si el hash no es v√°lido
        return False


--- rental-mvp/app/core/config.py ---
# app/core/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    DATABASE_URL: str           # p. ej. sqlite:///./rental.db
    SECRET_KEY: str             # usa algo largo y aleatorio
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 60

    class Config:
        env_file = ".env"

settings = Settings()


--- rental-mvp/app/core/security.py ---
# app/core/security.py
from datetime import datetime, timedelta
from jose import jwt
from app.core.config import settings

def create_access_token(subject: str) -> str:
    to_encode = {"sub": subject}
    expire = datetime.utcnow() + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)


--- rental-mvp/app/api/rentals.py ---
# app/api/rentals.py
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from typing import List

from app import crud, schemas
from app.deps import get_db, get_current_user

router = APIRouter()

@router.post("/", response_model=schemas.RentalOut, status_code=status.HTTP_201_CREATED)
def rent_item(rent_in: schemas.RentalCreate,
              db: Session = Depends(get_db),
              current_user=Depends(get_current_user)):
    # comprueba que el √≠tem est√° libre
    item = crud.get_item(db, rent_in.item_id)
    if not item or not item.available:
        raise HTTPException(400, "Item no disponible")
    return crud.create_rental(db, current_user.id, rent_in)

@router.get("/me", response_model=List[schemas.RentalOut])
def read_my_rentals(db: Session = Depends(get_db),
                    current_user=Depends(get_current_user)):
    return crud.get_rentals_by_user(db, current_user.id)

@router.post("/{rental_id}/return", response_model=schemas.RentalOut)
def return_item(rental_id: int,
                db: Session = Depends(get_db),
                current_user=Depends(get_current_user)):
    rental = crud.get_rental(db, rental_id)
    if not rental or rental.renter_id != current_user.id:
        raise HTTPException(404, "Alquiler no encontrado")
    return crud.mark_returned(db, rental)


--- rental-mvp/app/api/items.py ---
# app/api/items.py
from typing import List, Optional
from urllib.parse import urlencode

from fastapi import (
    APIRouter,
    Depends,
    HTTPException,
    Query,
    Request,
    Response,
    status,
)
from sqlalchemy.orm import Session

from app import crud, schemas
from app.deps import get_db, get_current_user

router = APIRouter()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Crear ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


@router.post(
    "/",
    response_model=schemas.ItemOut,
    status_code=status.HTTP_201_CREATED,
)
def create_item(
    item_in: schemas.ItemCreate,
    db: Session = Depends(get_db),
    current_user=Depends(get_current_user),
):
    """
    Crea un √≠tem asociado al usuario autenticado.
    """
    return crud.create_item(db, item_in, owner_id=current_user.id)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helpers paginaci√≥n (RFC-5988) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


def _build_pagination_links(
    request: Request,
    skip: int,
    limit: int,
    total: int,
    **filters,
) -> str:
    """
    Devuelve la cabecera **Link** con rel="next" y/o rel="prev"
    siguiendo la RFC-5988.
    """
    links: list[str] = []

    # eliminamos skip y limit existentes (solo se permite uno por llamada)
    base_url = request.url.remove_query_params("skip")
    base_url = base_url.remove_query_params("limit")

    def _url(new_skip: int) -> str:
        # ‚ñ∫ descartamos filtros cuyo valor sea None para no enviar "None" literal
        params = {k: v for k, v in filters.items() if v is not None}

        # urlencode con doseq=True para repetir par√°metros como categories=1&categories=2
        params.update({"skip": new_skip, "limit": limit})
        return f"<{base_url}?{urlencode(params, doseq=True)}>"

    # next
    if skip + limit < total:
        links.append(f'{_url(skip + limit)}; rel="next"')

    # prev
    if skip > 0:
        prev_skip = max(skip - limit, 0)
        links.append(f'{_url(prev_skip)}; rel="prev"')

    return ", ".join(links)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Leer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


@router.get("/", response_model=List[schemas.ItemOut])
def read_items(
    request: Request,
    response: Response,
    # ------------- paginaci√≥n -------------
    skip: int = Query(0, ge=0),
    limit: int = Query(100, ge=1, le=1000),
    # ------------- filtros ---------------
    name: Optional[str] = None,
    min_price: Optional[float] = Query(None, ge=0),
    max_price: Optional[float] = Query(None, ge=0),
    available: Optional[bool] = None,
    categories: Optional[List[int]] = Query(    # ‚Üê nuevo
        default=None,
        description="IDs de categor√≠as (cualquiera de ellas)",
    ),
    # ------------- ordenaci√≥n ------------
    order_by: Optional[str] = Query(
        None,
        pattern="^(price|name|id)$",
        description="Campo de ordenaci√≥n ('price'|'name'|'id')",
    ),
    order_dir: Optional[str] = Query(
        None,
        pattern="^(asc|desc)$",
        description="Direcci√≥n ('asc'|'desc')",
    ),
    # dependencia DB
    db: Session = Depends(get_db),
):
    """
    Lista p√∫blica de √≠tems con filtros, paginaci√≥n y soporte de ordenaci√≥n.

    Devuelve adem√°s cabeceras **X-Total-Count** y **Link** para facilitar la
    integraci√≥n con front-ends SPA.
    """
    items, total = crud.get_items(
        db,
        skip=skip,
        limit=limit,
        name=name,
        min_price=min_price,
        max_price=max_price,
        available=available,
        categories=categories,
        order_by=order_by,
        order_dir=order_dir,
    )

    # ‚ñ∫ cabeceras
    response.headers["X-Total-Count"] = str(total)
    if total:
        link = _build_pagination_links(
            request,
            skip,
            limit,
            total,
            name=name,
            min_price=min_price,
            max_price=max_price,
            available=available,
            categories=categories,
            order_by=order_by,
            order_dir=order_dir,
        )
        if link:
            response.headers["Link"] = link

    return items


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Mis √≠tems ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


@router.get("/me", response_model=List[schemas.ItemOut])
def read_my_items(
    db: Session = Depends(get_db),
    current_user=Depends(get_current_user),
):
    """
    Devuelve todos los √≠tems publicados por el usuario autenticado.
    """
    return crud.get_items_by_owner(db, current_user.id)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Actualizar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


@router.patch("/{item_id}", response_model=schemas.ItemOut)
def partial_update_item(
    item_id: int,
    item_in: schemas.ItemUpdate,
    db: Session = Depends(get_db),
    current_user=Depends(get_current_user),
):
    db_item = crud.get_item(db, item_id)
    if not db_item or db_item.owner_id != current_user.id:
        raise HTTPException(404, "Item no encontrado")
    return crud.update_item(db, db_item, item_in)


@router.put("/{item_id}", response_model=schemas.ItemOut)
def full_update_item(
    item_id: int,
    item_in: schemas.ItemCreate,
    db: Session = Depends(get_db),
    current_user=Depends(get_current_user),
):
    db_item = crud.get_item(db, item_id)
    if not db_item or db_item.owner_id != current_user.id:
        raise HTTPException(404, "Item no encontrado")
    # Reutilizamos la l√≥gica de PATCH convirtiendo ItemCreate ‚Üí ItemUpdate
    return crud.update_item(
        db,
        db_item,
        schemas.ItemUpdate(**item_in.model_dump()),
    )


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Eliminar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


@router.delete("/{item_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_item(
    item_id: int,
    db: Session = Depends(get_db),
    current_user=Depends(get_current_user),
):
    db_item = crud.get_item(db, item_id)
    if not db_item or db_item.owner_id != current_user.id:
        raise HTTPException(404, "Item no encontrado")
    crud.delete_item(db, db_item)


--- rental-mvp/app/api/categories.py ---
# app/api/categories.py
from typing import List

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session

from app import crud, schemas
from app.deps import get_db

# ‚¨á‚¨á‚¨á  ¬°SIN prefix aqu√≠!  ‚¨á‚¨á‚¨á
router = APIRouter(tags=["categories"])


@router.get("/", response_model=List[schemas.CategoryOut])
def list_categories(db: Session = Depends(get_db)):
    """Lista todas las categor√≠as ordenadas alfab√©ticamente."""
    return crud.get_categories(db)


@router.post("/", response_model=schemas.CategoryOut,
             status_code=status.HTTP_201_CREATED)
def create_category(cat_in: schemas.CategoryCreate,
                    db: Session = Depends(get_db)):
    """Crea una nueva categor√≠a (nombre √∫nico)."""
    return crud.create_category(db, cat_in)


@router.get("/{cat_id}", response_model=schemas.CategoryOut)
def get_category(cat_id: int, db: Session = Depends(get_db)):
    """Obtiene una categor√≠a por ID."""
    cat = crud.get_category(db, cat_id)
    if not cat:
        raise HTTPException(404, "Categor√≠a no encontrada")
    return cat


--- rental-mvp/app/api/auth.py ---
# app/api/auth.py
from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordRequestForm
from sqlalchemy.orm import Session

from app import crud, schemas
from app.deps import get_db
from app.core.security import create_access_token
from app.schemas.token import Token

router = APIRouter()


@router.post("/signup", response_model=schemas.UserOut, status_code=status.HTTP_201_CREATED)
def signup(user_in: schemas.UserCreate, db: Session = Depends(get_db)):
    if crud.get_user_by_username(db, user_in.username):
        raise HTTPException(400, "Nombre de usuario en uso")
    if crud.get_user_by_email(db, user_in.email):          # üÜï
        raise HTTPException(400, "Email ya registrado")
    return crud.create_user(db, user_in)


@router.post("/token", response_model=Token)
def login_for_access_token(
    form_data: OAuth2PasswordRequestForm = Depends(),
    db: Session = Depends(get_db),
):
    user = crud.get_user_by_username(db, form_data.username)
    if not user or not crud.verify_password(form_data.password, user.hashed_pw):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Usuario o contrase√±a incorrectos",
            headers={"WWW-Authenticate": "Bearer"},
        )
    access_token = create_access_token(subject=user.username)
    return {"access_token": access_token}


--- rental-mvp/app/api/__init__.py ---
# app/api/__init__.py
# paquete de routers


--- rental-mvp/app/api/upload.py ---
# app/api/upload.py
import os
import shutil
import uuid
from fastapi import APIRouter, UploadFile, Depends, HTTPException, Request
from starlette.status import HTTP_201_CREATED

from app.deps import get_current_user

UPLOAD_DIR = "./uploads"
os.makedirs(UPLOAD_DIR, exist_ok=True)

router = APIRouter()

@router.post("/", status_code=HTTP_201_CREATED)
async def upload_image(
    file: UploadFile,
    request: Request,
    user=Depends(get_current_user),
):
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ validaci√≥n simple ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if file.content_type.split("/")[0] != "image":
        raise HTTPException(status_code=400, detail="Solo se permiten im√°genes")

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ guardado en disco ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ext  = os.path.splitext(file.filename)[1]
    name = f"{uuid.uuid4()}{ext}"
    path = os.path.join(UPLOAD_DIR, name)

    with open(path, "wb") as buffer:
        shutil.copyfileobj(file.file, buffer)

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ URL p√∫blica del archivo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Genera la ruta absoluta bas√°ndose en el mount StaticFiles ‚Üí  /uploads/‚Ä¶
    url = request.url_for("uploads", path=name)      # http://<host>:<port>/uploads/<uuid>.<ext>

    return {"url": str(url)}


--- rental-mvp/tests/test_api.py ---
import datetime
from urllib.parse import parse_qs, urlparse

from fastapi import status


# ---------------------------------------------------------------------------
# helpers
# ---------------------------------------------------------------------------

def _signup(client, username="alice", email="alice@example.com", password="secret"):
    return client.post(
        "/api/auth/signup",
        json={"username": username, "email": email, "password": password},
    )


def _login(client, username="alice", password="secret"):
    res = client.post(
        "/api/auth/token",
        data={"username": username, "password": password},
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )
    return res.json()["access_token"]


# ---------------------------------------------------------------------------
# auth
# ---------------------------------------------------------------------------

def test_signup_login(client):
    r = _signup(client)
    assert r.status_code == status.HTTP_201_CREATED
    data = r.json()
    assert data["username"] == "alice"
    assert data["email"] == "alice@example.com"

    token = _login(client)
    assert token, "No se devolvi√≥ access_token"


# ---------------------------------------------------------------------------
# items + rentals flow
# ---------------------------------------------------------------------------

def test_item_crud_and_rental_flow(client):
    # usuarios
    _signup(client, "alice", "alice@example.com", "pwd")
    token_alice = _login(client, "alice", "pwd")
    auth_alice = {"Authorization": f"Bearer {token_alice}"}

    _signup(client, "bob", "bob@example.com", "pwd")
    token_bob = _login(client, "bob", "pwd")
    auth_bob = {"Authorization": f"Bearer {token_bob}"}

    # ‚ñ∫ Alice crea un √≠tem
    r = client.post(
        "/api/items/",
        json={"name": "Taladro Bosch", "description": "800 W", "price_per_h": 4.5},
        headers=auth_alice,
    )
    assert r.status_code == status.HTTP_201_CREATED
    item_id = r.json()["id"]

    # ‚ñ∫ Listado p√∫blico incluye el √≠tem
    r = client.get("/api/items/")
    assert any(it["id"] == item_id for it in r.json())

    # ‚ñ∫ Bob alquila el √≠tem
    start = datetime.datetime.utcnow()
    end = start + datetime.timedelta(hours=2)
    r = client.post(
        "/api/rentals/",
        json={"item_id": item_id, "start_at": start.isoformat(), "end_at": end.isoformat()},
        headers=auth_bob,
    )
    assert r.status_code == status.HTTP_201_CREATED
    rental = r.json()
    assert rental["deposit"] == round(2 * 4.5 * 1.2, 2)

    # ‚ñ∫ Devoluci√≥n
    r = client.post(f"/api/rentals/{rental['id']}/return", headers=auth_bob)
    assert r.status_code == status.HTTP_200_OK
    assert r.json()["returned"] is True


# ---------------------------------------------------------------------------
# PUT completo
# ---------------------------------------------------------------------------

def test_put_full_update_item(client):
    _signup(client, "neo", "n@e.o", "pwd")
    token = _login(client, "neo", "pwd")
    auth = {"Authorization": f"Bearer {token}"}

    # crea
    r = client.post(
        "/api/items/",
        json={"name": "Martillo", "description": "mango madera", "price_per_h": 3},
        headers=auth,
    )
    item_id = r.json()["id"]

    # reemplaza todos los campos
    r = client.put(
        f"/api/items/{item_id}",
        json={"name": "Martillo PRO", "description": "fibra", "price_per_h": 4},
        headers=auth,
    )
    assert r.status_code == status.HTTP_200_OK
    data = r.json()
    assert data["name"] == "Martillo PRO"
    assert data["price_per_h"] == 4


# ---------------------------------------------------------------------------
# nuevas coberturas
# ---------------------------------------------------------------------------

def test_rental_end_before_start_validation(client):
    """El esquema debe rechazar end_at ‚â§ start_at (422 Unprocessable Entity)."""
    _signup(client, "carl", "c@r.l", "pwd")
    token = _login(client, "carl", "pwd")
    auth = {"Authorization": f"Bearer {token}"}

    # necesita un √≠tem primero
    r = client.post("/api/items/", json={"name": "Sierra", "price_per_h": 2}, headers=auth)
    item_id = r.json()["id"]

    now = datetime.datetime.utcnow()
    r = client.post(
        "/api/rentals/",
        json={"item_id": item_id, "start_at": now.isoformat(), "end_at": now.isoformat()},
        headers=auth,
    )
    assert r.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY


def test_items_pagination_headers(client):
    """Verifica `X-Total-Count` y cabecera Link paginada."""
    _signup(client, "pag", "p@g.e", "pwd")
    token = _login(client, "pag", "pwd")
    auth = {"Authorization": f"Bearer {token}"}

    # crea 3 √≠tems
    for i in range(3):
        client.post(
            "/api/items/",
            json={"name": f"Item{i}", "price_per_h": 1 + i},
            headers=auth,
        )

    # p√°gina 1 (2 resultados)
    r = client.get("/api/items/?skip=0&limit=2")
    assert r.status_code == 200
    assert len(r.json()) == 2
    assert r.headers["X-Total-Count"] == "3"
    link = r.headers.get("Link")
    assert link and 'rel="next"' in link

    # parseamos la URL next
    next_url = link.split(";")[0].strip("<>")
    qs = parse_qs(urlparse(next_url).query)
    assert qs["skip"] == ["2"]
    assert qs["limit"] == ["2"]

    # p√°gina 2
    r2 = client.get(next_url)
    assert r2.status_code == 200
    assert len(r2.json()) == 1
    assert 'rel="prev"' in r2.headers.get("Link", "")


--- rental-mvp/tests/conftest.py ---
"""
Fixtures de prueba para FastAPI.

Para evitar colisiones entre tests, cada test recibe su propia base SQLite
en memoria.  Usamos un StaticPool para que todas las peticiones que se
ejecutan dentro del mismo test compartan la misma conexi√≥n.
"""

import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool

from app.main import app
from app.models.database import Base
from app.deps import get_db


@pytest.fixture()
def db():
    """
    Crea una base de datos SQLite en memoria exclusiva para el test
    y devuelve una sesi√≥n SQLAlchemy conectada a ella.
    """
    engine = create_engine(
        "sqlite://",
        connect_args={"check_same_thread": False},
        poolclass=StaticPool,           # <<‚Äî comparte conexi√≥n en el test
    )
    Base.metadata.create_all(bind=engine)

    TestingSessionLocal = sessionmaker(
        autocommit=False,
        autoflush=False,
        bind=engine,
    )

    session = TestingSessionLocal()
    try:
        yield session
    finally:
        session.close()


@pytest.fixture()
def client(db):
    """
    Devuelve un TestClient que usa la sesi√≥n `db` anterior para todas
    las dependencias `get_db` dentro de la app.
    """

    def override_get_db():
        try:
            yield db
        finally:
            pass

    # Sobrescribimos la dependencia
    app.dependency_overrides[get_db] = override_get_db

    with TestClient(app) as c:
        yield c


--- rental-mvp/.pytest_cache/.gitignore ---
# Created by pytest automatically.
*


--- rental-mvp/.pytest_cache/README.md ---
# pytest cache directory #

This directory contains data from the pytest's cache plugin,
which provides the `--lf` and `--ff` options, as well as the `cache` fixture.

**Do not** commit this to version control.

See [the docs](https://docs.pytest.org/en/stable/how-to/cache.html) for more information.


--- rental-mvp/.pytest_cache/CACHEDIR.TAG ---
Signature: 8a477f597d28d172789f06886806bc55
# This file is a cache directory tag created by pytest.
# For information about cache directory tags, see:
#	https://bford.info/cachedir/spec.html


--- rental-mvp/.pytest_cache/v/cache/nodeids ---
[
  "tests/test_api.py::test_item_crud_and_rental_flow",
  "tests/test_api.py::test_items_pagination_headers",
  "tests/test_api.py::test_put_full_update_item",
  "tests/test_api.py::test_rental_end_before_start_validation",
  "tests/test_api.py::test_signup_login"
]

--- rental-mvp/.pytest_cache/v/cache/lastfailed ---
{}

